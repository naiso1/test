<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>æ·±å‘¼å¸èª˜ç™ºã‚·ã‚¹ãƒ†ãƒ  â€“ Mobile v3</title>
<style>
:root{
  --color-inhale:#76c7c0;
  --color-hold:#f7c59f;
  --color-exhale:#ff6f61;
  --color-rest:#74b9ff;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","YuGothic","Meiryo",sans-serif;
  color:#fff;
  background:#000 url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1400&q=60') center/cover no-repeat fixed;
  display:flex;justify-content:center;align-items:center;min-height:100dvh;
}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55)}
.container{
  position:relative;z-index:1;width:min(95%,1040px);
  background:rgba(0,0,0,.6);border-radius:14px;padding:clamp(1rem,4vw,2rem);text-align:center;
  backdrop-filter:blur(12px);
  margin-top:120px;
  height:calc(100vh - 120px);
  display:flex;flex-direction:column;
  overflow-y:hidden;overflow-x:visible;
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.3) transparent;
}
.container::-webkit-scrollbar{width:6px}
.container::-webkit-scrollbar-track{background:transparent}
.container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.3);border-radius:3px}
.container h1{font-size:1.6rem;margin-bottom:4px}
.paramtable{width:100%;border-collapse:collapse;margin:16px 0;font-size:.9rem}
#customInputs{width:50%;margin:16px auto}
.paramtable th,.paramtable td{border:1px solid #999;padding:4px;text-align:center}
#customInputs th{white-space:nowrap}
label{display:block;margin:12px 0 4px;font-size:.9rem}
select,input[type="number"],input[type="color"]{
  width:100%;padding:6px 8px;font-size:1rem;border:none;border-radius:0;margin-bottom:12px;
  background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);
  backdrop-filter:blur(6px);
}
.patterns{width:100%;border-collapse:collapse;margin:12px auto;font-size:.8rem}
.patterns th,.patterns td{
  border:1px solid #999;padding:4px;font-size:min(.8rem,2.5vw);
  white-space:normal;line-height:1.2em;height:2.4em;
}
.patterns tbody tr.selected{background:rgba(255,255,255,.3)}
.patterns tbody tr:hover{background:rgba(255,255,255,.2)}
.section{margin:12px 0}
.section h3{margin-bottom:4px;font-weight:600}
.mode-buttons button,.env-buttons button,.switch-buttons button,.music-buttons button,.shape-buttons button{
  margin:0;padding:0;font-size:.8rem;cursor:pointer;border:2px solid transparent;border-radius:0;
  background:transparent;color:#fff;flex:0 0 auto;width:12.5%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
  white-space:nowrap;text-align:center;
}
.mode-buttons button.active,.env-buttons button.active,.switch-buttons button.active,.music-buttons button.active,.shape-buttons button.active{
  background:rgba(255,255,255,.2);color:#000;border-color:#fff;
}
.mode-buttons{margin:0}
.shape-buttons{margin:0}
#barContainer{
  position:fixed;
  top:240px;
  left:0;
  width:100%;
  height:40px;
  background:#444;
  border-radius:0;
  margin:0;
  z-index:3;
  overflow:hidden
}
#breathBar{
  position:absolute;left:50%;top:0;height:100%;width:0%;
  background:#fff;border-radius:20px;transform:translateX(-50%);
  transform-origin:center;border-radius:20px;
  transition:width 1s linear,background-color .8s
}
#breathPlane{
  position:fixed;
  inset:0;
  background:#fff;
  transform:scale(0);
  transform-origin:center;
  transition:transform 1s linear,background-color .8s linear;
  pointer-events:none;
  z-index:3;
  display:none
}
button{
  margin:4px;padding:10px;font-size:1rem;font-weight:600;border:none;border-radius:0;cursor:pointer;width:100%;
  background:rgba(255,255,255,.15);color:#fff;
}
#startBtn{background:rgba(118,199,192,.5);color:#fff}
#applyBtn{background:rgba(116,185,255,.5);color:#fff}
button:disabled{opacity:.6}
.controls{display:flex;gap:8px;justify-content:center;margin-top:8px}
.scroll-buttons{display:flex;gap:8px;justify-content:center;overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none}
.scroll-buttons::-webkit-scrollbar{display:none}
.env-buttons{-ms-overflow-style:auto;scrollbar-width:auto}
.env-buttons::-webkit-scrollbar{display:block;height:6px}
.env-buttons::-webkit-scrollbar-track{background:rgba(255,255,255,.1)}
.env-buttons::-webkit-scrollbar-thumb{background:rgba(255,255,255,.4)}
.mode-buttons img,.env-buttons img,.switch-buttons img,.music-buttons img{
  width:100%;aspect-ratio:1/1;object-fit:cover
}
.noimg{
  width:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;
  background:#555;color:#fff;font-size:.6rem
}
#phaseText,#timerText{margin:4px 0}
#fixedArea{position:sticky;top:0;background:rgba(0,0,0,.6);padding-bottom:8px;z-index:2}
#settings{flex:1;overflow-y:auto;overflow-x:hidden}
@media(hover:hover) and (pointer:fine){button:hover{filter:brightness(.9);border-color:rgba(255,255,255,.6)}}
</style>
</head>
<body>
<div class="overlay"></div>
<div id="barContainer"><div id="breathBar"></div></div>
<div id="breathPlane"></div>
<div class="container">
  <div id="fixedArea">
    <h1>æ·±å‘¼å¸èª˜ç™ºã‚·ã‚¹ãƒ†ãƒ </h1>

    <div id="phaseText">æº–å‚™ä¸­...</div>
    <div id="timerText">--</div>
    <div id="controls" class="controls">
      <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="settingsBtn">è¨­å®š</button>
    </div>
  </div>


  <div id="settings" style="display:none">
  <h3>å‘¼å¸ãƒªã‚ºãƒ </h3>
  <p style="margin-bottom:8px;font-size:.9rem">ä¸‹è¨˜ã®è¡¨ã‚’å‚è€ƒã«ç›®çš„ã«åˆã£ãŸå‘¼å¸æ³•ã‚’é¸æŠã—ã€å›æ•°ã‚„æ™‚é–“ã‚’è¨­å®šã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚</p>

  <table class="patterns">
    <thead>
      <tr><th>å‘¼å¸ãƒªã‚ºãƒ </th><th>åç§°</th><th>ä¸»ãªç›®çš„ãƒ»é©ç”¨ã‚·ãƒ¼ãƒ³</th><th>ä¸»ãªèº«ä½“çš„å¤‰åŒ–</th><th>ä¸»ãªå¿ƒç†çš„å¤‰åŒ–</th><th>æ¨å¥¨å›æ•°/æ™‚é–“</th></tr>
    </thead>
    <tbody>
      <tr data-pattern="3.3-0-6.7-0"><td>3.3-6.7</td><td>ãƒ¬ã‚¾ãƒŠãƒ³ã‚¹ï¼‹ãƒ¯ãƒ³ãƒ„ãƒ¼å‘¼å¸æ³•</td><td>ä»•äº‹ä¸­ãƒ»é‹è»¢å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</td><td>æœ«æ¢¢è¡€æµâ†‘ã€å¿ƒæ‹â†“</td><td>ã‚¹ãƒˆãƒ¬ã‚¹ã‚¹ã‚³ã‚¢â†“ã€æ°—åˆ†å›å¾©</td><td>5åˆ†</td></tr>
      <tr data-pattern="resStep"><td>åˆæœŸï½3.3-6.7</td><td>ãƒ¬ã‚¾ãƒŠãƒ³ã‚¹ï¼‹ãƒ¯ãƒ³ãƒ„ãƒ¼å‘¼å¸æ³•<br>ï¼ˆå¾ã€…ã«èª˜å°ï¼‰</td><td>ä»•äº‹ä¸­ãƒ»é‹è»¢å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</td><td>æœ«æ¢¢è¡€æµâ†‘ã€å¿ƒæ‹â†“</td><td>ã‚¹ãƒˆãƒ¬ã‚¹ã‚¹ã‚³ã‚¢â†“ã€æ°—åˆ†å›å¾©</td><td>5åˆ†</td></tr>
      <tr data-pattern="4-7-8-0"><td>4-7-8</td><td>4-7-8å‘¼å¸æ³•</td><td>å…¥çœ å‰ãƒ»æ€¥æ€§ä¸å®‰ã®é®é™</td><td>HRVâ†‘ã€å¿ƒæ‹â†“ã€è¡€åœ§â†“</td><td>å…¥çœ æ™‚é–“çŸ­ç¸®ã€ä¸»è¦³çš„ä¸å®‰â†“</td><td>4ã‚»ãƒƒãƒˆ</td></tr>
      <tr data-pattern="4-4-4-4"><td>4-4-4-4</td><td>ãƒœãƒƒã‚¯ã‚¹å‘¼å¸æ³•</td><td>é«˜ã‚¹ãƒˆãƒ¬ã‚¹ä¸‹ã§ã®é›†ä¸­ç¶­æŒ<br>ï¼ˆè»ãƒ»è­¦å¯Ÿè¨“ç·´ã»ã‹ï¼‰</td><td>å‰¯äº¤æ„Ÿå„ªä½åŒ–ã€ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«â†“</td><td>é›†ä¸­åŠ›â†‘ã€æƒ…å‹•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</td><td>3åˆ†</td></tr>
      <tr data-pattern="5-0-5-0"><td>5-5</td><td>ãƒ¬ã‚¾ãƒŠãƒ³ã‚¹å‘¼å¸æ³•</td><td>HRVæœ€å¤§åŒ–ã€é•·æœŸã‚¹ãƒˆãƒ¬ã‚¹è€æ€§</td><td>HRVâ†‘ã€è¡€åœ§å¤‰å‹•æ•´æµ</td><td>æ°—åˆ†å®‰å®šã€èªçŸ¥æŸ”è»Ÿæ€§â†‘</td><td>5åˆ†</td></tr>
      <tr data-pattern="7-0-11-0"><td>7-11</td><td>7-11ãƒ–ãƒªãƒ¼ã‚¸ãƒ³ã‚°</td><td>æ€¥æ€§ã®ç·Šå¼µç·©å’Œã€èˆå°å‰ãƒ»å•†è«‡å‰</td><td>å‘¼å¸æ•°â†“ã€è¿·èµ°ç¥çµŒåˆºæ¿€</td><td>ä¸å®‰â†“ã€è½ã¡ç€ãâ†‘</td><td>3åˆ†</td></tr>
      <tr data-pattern="music"><td>1:2</td><td>éŸ³æ¥½é€£å‹•</td><td>éŸ³æ¥½é‘‘è³æ™‚</td><td>ï¼</td><td>ï¼</td><td>éŸ³æ¥½ã«ã‚ˆã‚‹</td></tr>
      <tr data-pattern="custom"><td>-</td><td>ã‚«ã‚¹ã‚¿ãƒ </td><td colspan="4">ä»»æ„è¨­å®š</td></tr>
    </tbody>
  </table>
  <p style="font-size:.8rem;opacity:.6">* æ¨å¥¨å›æ•°/æ™‚é–“ã¯ä¸€èˆ¬çš„ãªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ç›®å®‰ã§ã™ã€‚ä½“èª¿ã‚„ç›®çš„ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</p>

  <input type="hidden" id="patternSelect" value="3.3-0-6.7-0">

  <table id="customInputs" class="paramtable">
    <thead>
      <tr>
        <th></th>
        <th>ğŸ« å¸ã†</th>
        <th>â¸ï¸ æ­¢ã‚ã‚‹</th>
        <th>ğŸ’¨ åã</th>
        <th>â¸ï¸ æ­¢ã‚ã‚‹</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>ç§’æ•°</th>
        <td><input type="number" id="inhaleSec" min="1" value="5"></td>
        <td><input type="number" id="holdSec" min="0" value="0"></td>
        <td><input type="number" id="exhaleSec" min="1" value="5"></td>
        <td><input type="number" id="restSec" min="0" value="0"></td>
      </tr>
      <tr>
        <th>è‰²</th>
        <td><input type="color" id="colorInhale" value="#76c7c0"></td>
        <td><input type="color" id="colorHold" value="#f7c59f"></td>
        <td><input type="color" id="colorExhale" value="#ff6f61"></td>
        <td><input type="color" id="colorRest" value="#74b9ff"></td>
      </tr>
      <tr>
        <th>å›æ•°(0=ç„¡é™)</th>
        <td colspan="4"><input type="number" id="cycleCount" min="0" value="0"></td>
      </tr>
      <tr>
        <th>æ™‚é–“(åˆ†,0=ç„¡é™)</th>
        <td colspan="4"><input type="number" id="totalMinutes" min="0" value="0"></td>
      </tr>
      <tr class="resStepRow">
        <th>åˆæœŸãƒªã‚ºãƒ ï¼šå¸ã†(ç§’)</th>
        <td colspan="4"><input type="number" id="initInhale" step="0.1" value="2.5"></td>
      </tr>
      <tr class="resStepRow">
        <th>åˆæœŸãƒªã‚ºãƒ ï¼šåã(ç§’)</th>
        <td colspan="4"><input type="number" id="initExhale" step="0.1" value="2.5"></td>
      </tr>
      <tr class="resStepRow">
        <th>èª˜å°æ™‚é–“(ç§’)</th>
        <td colspan="4"><input type="number" id="induceTime" step="1" value="60"></td>
      </tr>
    </tbody>
  </table>

  <div class="section">
    <h3>å…‰ã®å½¢çŠ¶</h3>
    <div class="shape-buttons scroll-buttons">
      <button type="button" class="shapeBtn" data-shape="none"><div class="noimg">ç”»åƒãªã—</div> ãªã—</button>
      <button type="button" class="shapeBtn active" data-shape="line"><div class="noimg">ãƒãƒ¼</div> ç·š</button>
      <button type="button" class="shapeBtn" data-shape="plane"><div class="noimg">é¢</div> é¢</button>
    </div>
  </div>

  <div class="section" id="modeSection">
    <h3>å…‰ã®è¡¨ç¾</h3>
    <div class="mode-buttons scroll-buttons">
      <button type="button" class="modeBtn" data-mode="off"><div class="noimg">ç”»åƒãªã—</div> ãªã—</button>
      <button type="button" class="modeBtn active" data-mode="expand"><img src="å…‰ã®åºƒãŒã‚Š.gif" alt=""> æ‹¡ç¸®</button>
      <button type="button" class="modeBtn" data-mode="color"><img src="è‰²å¤‰åŒ–.gif" alt=""> è‰²å¤‰åŒ–</button>
      <button type="button" class="modeBtn" data-mode="fade"><img src="ãƒ•ã‚§ãƒ¼ãƒ‰.gif" alt=""> ãƒ•ã‚§ãƒ¼ãƒ‰</button>
    </div>
  </div>
  <div class="section">
    <h3>ç’°å¢ƒéŸ³</h3>
    <div class="env-buttons scroll-buttons">
      <button type="button" class="envBtn active" data-env="off"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=" alt=""> ãªã—</button>
      <button type="button" class="envBtn" data-env="wave"><img src="æ³¢ã®éŸ³.jpg" alt=""> æ³¢ã®éŸ³</button>
      <button type="button" class="envBtn" data-env="birds"><img src="é³¥ã®ã•ãˆãšã‚Š.jpg" alt=""> é³¥ã®ã•ãˆãšã‚Š</button>
      <button type="button" class="envBtn" data-env="onsen"><img src="æ¸©æ³‰ã®éŸ³.jpg" alt=""> æ¸©æ³‰ã®éŸ³</button>
      <button type="button" class="envBtn" data-env="bubble"><img src="æ³¡é¢¨å‘‚.jpeg" alt=""> æ³¡é¢¨å‘‚</button>
      <button type="button" class="envBtn" data-env="water"><img src="æ°´.jpg" alt=""> æ°´</button>
      <button type="button" class="envBtn" data-env="wind"><img src="é¢¨ã®éŸ³.png" alt=""> é¢¨ã®éŸ³</button>
      <button type="button" class="envBtn" data-env="rain"><img src="é›¨ã®éŸ³.jpg" alt=""> é›¨ã®éŸ³</button>
      <button type="button" class="envBtn" data-env="kirakira"><img src="ã‚­ãƒ©ã‚­ãƒ©.jpg" alt=""> ã‚­ãƒ©ã‚­ãƒ©</button>
    </div>
  </div>
  <div class="section">
    <h3>åˆ‡ã‚Šæ›¿ãˆéŸ³</h3>
    <div class="switch-buttons scroll-buttons">
      <button type="button" class="switchBtn active" data-switch="off"><div class="noimg">ç”»åƒãªã—</div> ãªã—</button>
      <button type="button" class="switchBtn" data-switch="shishi"><img src="ã—ã—ãŠã©ã—.jpg" alt=""> ã—ã—ãŠã©ã—</button>
    </div>
  </div>
  <div class="section">
    <h3>éŸ³æ¥½</h3>
  <div class="music-buttons scroll-buttons">
      <button type="button" class="musicBtn active" data-music="off"><div class="noimg">ç”»åƒãªã—</div> ãªã—</button>
      <button type="button" class="musicBtn" data-music="canon"><img src="ã‚«ãƒãƒ³.jpg" alt=""> ã‚«ãƒãƒ³</button>
      <button type="button" class="musicBtn" data-music="aria"><img src="gç·šä¸Šã®ã‚¢ãƒªã‚¢.jpg" alt=""> Gç·šä¸Šã®ã‚¢ãƒªã‚¢</button>
    </div>
  </div>
  <div class="controls" style="margin-top:8px">
    <button id="applyBtn" style="display:none">é©ç”¨</button>
  </div>
  </div>
  <input type="hidden" id="envSound" value="off">
  <input type="hidden" id="switchSound" value="off">
  <input type="hidden" id="musicSel" value="off">

  <footer style="margin-top:8px;font-size:.7rem;opacity:.5">v3 â€“ Generated 2025-06-06 07:59:20</footer>
</div>

<script>
(function(){
  const patternSelect = document.getElementById('patternSelect');
  const customInputs  = document.getElementById('customInputs');
  const startBtn      = document.getElementById('startBtn');
  const breathBar     = document.getElementById('breathBar');
  const phaseText     = document.getElementById('phaseText');
  const timerText     = document.getElementById('timerText');
  const envSel        = document.getElementById('envSound');
  const switchSel     = document.getElementById('switchSound');
  const musicSel      = document.getElementById('musicSel');
  const cycleInput    = document.getElementById('cycleCount');
  const minuteInput   = document.getElementById('totalMinutes');
  const applyBtn      = document.getElementById('applyBtn');
  const settings      = document.getElementById('settings');
  const settingsBtn   = document.getElementById('settingsBtn');
  const footer        = document.querySelector('footer');
  const patternRows   = document.querySelectorAll('.patterns tbody tr');
  const modeBtns      = document.querySelectorAll('.modeBtn');
  const shapeBtns     = document.querySelectorAll('.shapeBtn');
  const envBtns       = document.querySelectorAll('.envBtn');
  const switchBtns    = document.querySelectorAll('.switchBtn');
  const musicBtns     = document.querySelectorAll('.musicBtn');
  const barContainer  = document.getElementById('barContainer');
  const breathPlane   = document.getElementById('breathPlane');
  const modeSection   = document.getElementById('modeSection');
  let selectedEnvs = [];
  let lastEnv = 'off';
  const canonMinutes = 431.654/60;
  const ariaMinutes  = 355.66/60;
  const ENV_MAX_VOL = 0.8;

  const defaultBg = 'https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1400&q=60';
  const bgMap = {
    off: defaultBg,
    wave: 'æ³¢ã®éŸ³.jpg',
    birds: 'é³¥ã®ã•ãˆãšã‚Š.jpg',
    onsen: 'æ¸©æ³‰ã®éŸ³.jpg',
    bubble: 'æ³¡é¢¨å‘‚.jpeg',
    water: 'æ°´.jpg',
    wind: 'é¢¨ã®éŸ³.png',
    rain: 'é›¨ã®éŸ³.jpg',
    kirakira: 'ã‚­ãƒ©ã‚­ãƒ©.jpg'
  };

  function updateBackground(){
    const url = bgMap[lastEnv] || defaultBg;
    document.body.style.background = `#000 url('${url}') center/cover no-repeat fixed`;
  }

  const recommendedMap = {
    '4-7-8-0': '4ã‚»ãƒƒãƒˆ',
    '4-4-4-4': '3åˆ†',
    '5-0-5-0': '5åˆ†',
    '3.3-0-6.7-0': '5åˆ†',
    '7-0-11-0': '3åˆ†',
    'resStep': '5åˆ†'
  };

  let timerId = null;
  let currentPhase = 0;
  let mode = 'expand';
  let shape = 'line';
  let running = false;
  let cycleLimit = 0;
  let timeLimit  = 0;
  let cyclesDone = 0;
  let startTime  = 0;
  let cycleStarted = false;

  const phaseNames = ['å¸ã£ã¦ã€œ','æ­¢ã‚ã¦ã€œ','åã„ã¦ã€œ','æ­¢ã‚ã¦ã€œ'];

  const inhaleInput = document.getElementById('inhaleSec');
  const holdInput   = document.getElementById('holdSec');
  const exhaleInput = document.getElementById('exhaleSec');
  const restInput   = document.getElementById('restSec');
  const initInhaleInput = document.getElementById('initInhale');
  const initExhaleInput = document.getElementById('initExhale');
  const induceTimeInput = document.getElementById('induceTime');

  function updateInputsFromPattern(){
    const arr = patternSelect.value.split('-').map(n=>parseFloat(n));
    while(arr.length < 4) arr.push(0);
    if(patternSelect.value==='music'){
      arr[0]=musicSel.value==='canon'?3.636363636:0;
      arr[2]=musicSel.value==='canon'?7.272727273:0;
      arr[1]=arr[3]=0;
    } else if(patternSelect.value==='resStep'){
      arr=[3.3,0,6.7,0];
    }
    [inhaleInput,holdInput,exhaleInput,restInput].forEach((el,i)=>{
      if(patternSelect.value !== 'custom') el.value = arr[i];
      el.disabled = patternSelect.value !== 'custom';
    });
    const initEnabled = patternSelect.value==='resStep' || patternSelect.value==='custom';
    [initInhaleInput,initExhaleInput,induceTimeInput].forEach(el=>{el.disabled=!initEnabled;});
    const rec = recommendedMap[patternSelect.value];
    if(rec){
      if(rec.includes('ã‚»ãƒƒãƒˆ')){
        const m = rec.match(/(\d+)/g);
        cycleInput.value = m ? parseInt(m[m.length-1]) : 0;
        minuteInput.value = 0;
      } else if(rec.includes('åˆ†')){
        const m = rec.match(/(\d+)(?:-(\d+))?/);
        minuteInput.value = m ? parseInt(m[2] || m[1]) : 0;
        cycleInput.value = 0;
      }
    }
  }

  patternRows.forEach(row => {
    if(row.dataset.pattern===patternSelect.value) row.classList.add('selected');
    row.addEventListener('click', () => {
      patternRows.forEach(r=>r.classList.remove('selected'));
      row.classList.add('selected');
      patternSelect.value = row.dataset.pattern;
      updateInputsFromPattern();
    });
  });
  updateInputsFromPattern();
  function startEnvSound(env){
    const obj = envAudios[env];
    if(!obj) return;
    if(obj.audio.paused) obj.audio.play().catch(()=>{});
    obj.gain.gain.cancelScheduledValues(audioCtx.currentTime);
    obj.gain.gain.setValueAtTime(ENV_MAX_VOL, audioCtx.currentTime);
  }
  envBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      await audioCtx.resume();
      const env = btn.dataset.env;
      if(env === 'off'){
        selectedEnvs.forEach(stopEnvSound);
        selectedEnvs = [];
        lastEnv = 'off';
        envBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        btn.classList.toggle('active');
        if(btn.classList.contains('active')){
          selectedEnvs.push(env);
          lastEnv = env;
          startEnvSound(env);
        } else {
          selectedEnvs = selectedEnvs.filter(e=>e!==env);
          stopEnvSound(env);
          if(lastEnv===env) lastEnv = selectedEnvs[selectedEnvs.length-1] || 'off';
        }
        envBtns.forEach(b=>{if(b.dataset.env==='off') b.classList.remove('active');});
        if(selectedEnvs.length===0){
          document.querySelector('.envBtn[data-env="off"]').classList.add('active');
          lastEnv = 'off';
        }
      }
      envSel.value = selectedEnvs.join(',');
      updateBackground();
    });
  });
  document.querySelector('.envBtn[data-env="off"]').classList.add('active');
  switchBtns.forEach(btn => {
    if(btn.dataset.switch===switchSel.value) btn.classList.add('active');
    btn.addEventListener('click', () => {
      switchBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      switchSel.value = btn.dataset.switch;
    });
  });
  musicBtns.forEach(btn => {
    if(btn.dataset.music===musicSel.value) btn.classList.add('active');
    btn.addEventListener('click', async () => {
      musicBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      musicSel.value = btn.dataset.music;
      if(btn.dataset.music==='canon') minuteInput.value = canonMinutes.toFixed(1);
      else if(btn.dataset.music==='aria') minuteInput.value = ariaMinutes.toFixed(1);
      if(patternSelect.value==='music' && btn.dataset.music!=='off'){
        await stopSession();
        await startSession();
      }else{
        handleMusic();
      }
    });
  });
  document.querySelectorAll('.scroll-buttons').forEach(sc => {
    let down=false,startX=0,scroll=0;
    sc.addEventListener('pointerdown',e=>{
      down=true;startX=e.clientX;scroll=sc.scrollLeft;sc.style.cursor='grabbing';
    });
    sc.addEventListener('pointermove',e=>{if(down) sc.scrollLeft=scroll-(e.clientX-startX);});
    const end=()=>{down=false;sc.style.cursor='';};
    sc.addEventListener('pointerup',end);
    sc.addEventListener('pointerleave',end);
    sc.addEventListener('pointercancel',end);
  });
  updateBackground();
  function updateShapeVisibility(){
    if(shape==='line'){
      barContainer.style.display='';
      breathPlane.style.display='none';
      modeSection.style.display='';
    }else if(shape==='plane'){
      barContainer.style.display='none';
      breathPlane.style.display='';
      modeSection.style.display='';
    }else{
      barContainer.style.display='none';
      breathPlane.style.display='none';
      modeSection.style.display='none';
    }
  }
  updateShapeVisibility();
  shapeBtns.forEach(btn=>{
    if(btn.dataset.shape===shape) btn.classList.add('active');
    btn.addEventListener('click',()=>{
      shapeBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      shape = btn.dataset.shape;
      updateShapeVisibility();
    });
  });
  modeBtns.forEach(btn => {
    if(btn.dataset.mode===mode) btn.classList.add('active');
    btn.addEventListener('click', () => {
      modeBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      mode = btn.dataset.mode;
      if(mode === 'fade'){
        applyFadeColors();
      } else {
        restoreDefaultColors();
      }
    });
  });

  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  function createEnvAudio(src){
    const audio = new Audio(src);
    audio.preload = 'auto';
    const node  = audioCtx.createMediaElementSource(audio);
    const gain  = audioCtx.createGain();
    node.connect(gain).connect(audioCtx.destination);
    audio.loop = true;
    audio.load();
    return {audio,gain,fade:null};
  }
  const envAudios = {
    wave:createEnvAudio('æ³¢ã®éŸ³.mp3'),
    birds:createEnvAudio('é³¥ã®ã•ãˆãšã‚Š.mp3'),
    onsen:createEnvAudio('æ¸©æ³‰ã®éŸ³.mp3'),
    bubble:createEnvAudio('æ³¡é¢¨å‘‚.mp3'),
    water:createEnvAudio('æ°´.mp3'),
    wind:createEnvAudio('é¢¨ã®éŸ³.mp3'),
    rain:createEnvAudio('é›¨ã®éŸ³.mp3'),
    kirakira:createEnvAudio('ã‚­ãƒ©ã‚­ãƒ©.mp3')
  };
  const switchAudios = {shishi:new Audio('ã—ã—ãŠã©ã—.mp3')};
  const musicAudios = {canon:new Audio('ã‚«ãƒãƒ³.m4a'), aria:new Audio('Gç·šä¸Šã®ã‚¢ãƒªã‚¢.m4a')};

  function stopEnvSound(env){
    const obj = envAudios[env];
    if(obj){
      if(obj.fade) clearInterval(obj.fade);
      try{obj.audio.pause();}catch{}
      obj.audio.currentTime = 0;
      obj.gain.gain.cancelScheduledValues(audioCtx.currentTime);
      obj.gain.gain.setValueAtTime(0, audioCtx.currentTime);
    }
  }

  function handleMusic(forceStop=false){
    Object.values(musicAudios).forEach(a=>{try{a.pause();}catch{} if(forceStop) a.currentTime=0;});
    if(!forceStop && running && musicSel.value!=='off'){
      const el = musicAudios[musicSel.value];
      if(el){ el.volume=0.8; el.play().catch(()=>{}); }
    }
  }

  function playEnv(dur, from, to){
    if(selectedEnvs.length===0) return;
    selectedEnvs.forEach(env=>{
      const obj = envAudios[env];
      if(!obj) return;
      if(obj.audio.paused) obj.audio.play().catch(()=>{});
      obj.gain.gain.cancelScheduledValues(audioCtx.currentTime);
      obj.gain.gain.setValueAtTime(from*ENV_MAX_VOL, audioCtx.currentTime);
      obj.gain.gain.linearRampToValueAtTime(to*ENV_MAX_VOL, audioCtx.currentTime + dur);
      if(obj.fade) clearInterval(obj.fade);
      if(to===0){
        obj.fade = setTimeout(()=>{ try{obj.audio.pause();}catch{} obj.audio.currentTime=0; }, dur*1000+50);
      }
    });
  }

  function playSwitchSound(){
    if(switchSel.value==='off') return;
    const el = switchAudios[switchSel.value];
    if(el){ el.currentTime=0; el.volume=1; el.play().catch(()=>{}); }
  }

  function getDurations(){
    if(patternSelect.value === 'custom'){
      const inhale = parseFloat(inhaleInput.value) || 0;
      const hold   = parseFloat(holdInput.value) || 0;
      const exhale = parseFloat(exhaleInput.value) || 0;
      const rest   = parseFloat(restInput.value) || 0;
      return [inhale,hold,exhale,rest];
    }
    if(patternSelect.value === 'music'){
      return [
        musicSel.value!=='off'?3.636363636:0,
        0,
        musicSel.value!=='off'?7.272727273:0,
        0
      ];
    }
    if(patternSelect.value === 'resStep'){
      const initIn = parseFloat(initInhaleInput.value)||0;
      const initEx = parseFloat(initExhaleInput.value)||0;
      const dur    = parseFloat(induceTimeInput.value)||1;
      const prog   = running?Math.min(1,(Date.now()-startTime)/(dur*1000)):0;
      const inhale = initIn + (3.3 - initIn)*prog;
      const exhale = initEx + (6.7 - initEx)*prog;
      return [inhale,0,exhale,0];
    }
    const arr = patternSelect.value.split('-').map(n=>parseFloat(n));
    while(arr.length < 4) arr.push(0);
    return arr;
  }
  const colorInhale = document.getElementById('colorInhale');
  const colorHold   = document.getElementById('colorHold');
  const colorExhale = document.getElementById('colorExhale');
  const colorRest   = document.getElementById('colorRest');
  const defaultColors = {
    hold: colorHold.value,
    exhale: colorExhale.value,
    rest: colorRest.value
  };

  function applyFadeColors(){
    const c = colorInhale.value;
    colorHold.value = c;
    colorExhale.value = c;
    colorRest.value = c;
  }

  function restoreDefaultColors(){
    colorHold.value = defaultColors.hold;
    colorExhale.value = defaultColors.exhale;
    colorRest.value = defaultColors.rest;
  }

  colorInhale.addEventListener('change', () => {
    if(mode === 'fade') applyFadeColors();
  });

  restoreDefaultColors();

  function getColors(){
    return [
      colorInhale.value,
      colorHold.value,
      colorExhale.value,
      colorRest.value
    ];
  }
  function setBar(widthPercent,widthDur,color,colorDur){
    breathBar.style.transition = `width ${widthDur}s linear, background-color ${colorDur}s linear`;
    breathBar.style.width = widthPercent + '%';
    breathBar.style.backgroundColor = color;
  }
  function setPlane(scale,dur,color,colorDur){
    breathPlane.style.transition = `transform ${dur}s linear, background-color ${colorDur}s linear`;
    breathPlane.style.transform = `scale(${scale})`;
    breathPlane.style.backgroundColor = color;
  }

  async function stopSession(){
    if(timerId) clearInterval(timerId);
    timerId = null;
    running = false;
    breathBar.style.transition = 'none';
    breathBar.style.width = '0%';
    void breathBar.offsetWidth;
    breathBar.style.transition = '';
    breathPlane.style.transition = 'none';
    breathPlane.style.transform = 'scale(0)';
    breathPlane.style.backgroundColor = 'transparent';
    void breathPlane.offsetWidth;
    breathPlane.style.transition = '';
    phaseText.textContent = 'æº–å‚™ä¸­...';
    timerText.textContent = '--';
    startBtn.disabled = false;
    startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
    Object.values(envAudios).forEach(obj=>{
      if(obj.fade) clearTimeout(obj.fade);
      try{obj.audio.pause();}catch{}
      obj.audio.currentTime = 0;
      obj.gain.gain.cancelScheduledValues(audioCtx.currentTime);
      obj.gain.gain.setValueAtTime(0, audioCtx.currentTime);
    });
    Object.values(switchAudios).forEach(el=>{try{el.pause();}catch{} el.currentTime=0;});
    handleMusic(true);
    audioCtx.suspend();
  }

  function nextPhase(){
    const durations = getDurations();
    const colors    = getColors();

    let guard = 0;
    while(durations[currentPhase] === 0 && guard < 4){
      currentPhase = (currentPhase + 1) % 4;
      guard++;
    }

    if(currentPhase === 0){
      if(cycleStarted){
        cyclesDone++;
        if(cycleLimit > 0 && cyclesDone >= cycleLimit){
          stopSession();
          return;
        }
      }
      cycleStarted = true;
    }
    if(timeLimit > 0 && Date.now() - startTime >= timeLimit){
      stopSession();
      return;
    }

    const duration = durations[currentPhase];
    const color    = colors[currentPhase];

    phaseText.textContent = phaseNames[currentPhase] || '';
    if(shape === 'line'){
      if(mode === 'expand'){
        setBar(currentPhase < 2 ? 100 : 0, duration, color, 0.8);
      } else if(mode === 'color') {
        setBar(100, 0, color, 0.8);
      } else if(mode === 'fade') {
        if(currentPhase === 0){
          breathBar.style.transition = 'background-color 0s';
          breathBar.style.backgroundColor = '#000';
          void breathBar.offsetWidth;
          setBar(100, 0, color, duration);
        } else if(currentPhase === 1){
          setBar(100, 0, color, 0);
        } else if(currentPhase === 2){
          breathBar.style.transition = 'background-color 0s';
          breathBar.style.backgroundColor = color;
          void breathBar.offsetWidth;
          setBar(100, 0, '#000', duration);
        } else {
          setBar(100, 0, color, 0);
        }
      } else {
        setBar(0, 0, 'transparent', 0);
      }
    } else if(shape === 'plane'){
      if(mode === 'expand'){
        setPlane(currentPhase < 2 ? 1 : 0, duration, color, 0.8);
      } else if(mode === 'color'){
        setPlane(1, 0, color, 0.8);
      } else if(mode === 'fade'){
        if(currentPhase === 0){
          breathPlane.style.transition = 'background-color 0s';
          breathPlane.style.backgroundColor = '#000';
          void breathPlane.offsetWidth;
          setPlane(1, 0, color, duration);
        } else if(currentPhase === 1){
          setPlane(1, 0, color, 0);
        } else if(currentPhase === 2){
          breathPlane.style.transition = 'background-color 0s';
          breathPlane.style.backgroundColor = color;
          void breathPlane.offsetWidth;
          setPlane(1, 0, '#000', duration);
        } else {
          setPlane(1, 0, color, 0);
        }
      } else {
        setPlane(0, 0, 'transparent', 0);
      }
    }

    if(currentPhase === 0){
      playSwitchSound();
      playEnv(duration,0,1);
    } else if(currentPhase === 1){
      playSwitchSound();
      playEnv(duration,1,1);
    } else if(currentPhase === 2){
      playSwitchSound();
      playEnv(duration,1,0);
    } else if(currentPhase === 3){
      playSwitchSound();
      playEnv(duration,0,0);
    }

    if(duration === 0){
      currentPhase = (currentPhase + 1) % 4;
      nextPhase();
      return;
    }

    let start = Date.now();
    let end   = start + duration*1000;
    timerText.textContent = duration.toFixed(1) + ' ç§’';

    timerId = setInterval(()=>{
      const now = Date.now();
      const remaining = Math.max(0,(end - now)/1000);
      timerText.textContent = remaining.toFixed(1) + ' ç§’';

      if(timeLimit > 0 && now - startTime >= timeLimit){
        stopSession();
        return;
      }

      if(remaining <= 0){
        clearInterval(timerId);
        currentPhase = (currentPhase + 1) % 4;
        nextPhase();
      }
    }, 100);
  }

  async function startSession(){
    await audioCtx.resume();
    running = true;
    currentPhase = 0;
    cyclesDone = 0;
    cycleStarted = false;
    cycleLimit = parseInt(cycleInput.value,10) || 0;
    timeLimit  = (parseFloat(minuteInput.value) || 0) * 60000;
    startTime  = Date.now();
    handleMusic();
    nextPhase();
    startBtn.textContent = 'ã‚¹ãƒˆãƒƒãƒ—';
  }

  startBtn.addEventListener('click', async ()=>{
    if(running){
      await stopSession();
    }else{
      await startSession();
    }
  });

  applyBtn.addEventListener('click', async ()=>{
    await stopSession();
    await startSession();
  });

  settings.querySelectorAll('input,select').forEach(el=>{
    el.addEventListener('change',()=>{ applyBtn.style.display=''; });
  });

  settingsBtn.addEventListener('click', ()=>{
    const open = settings.style.display !== 'none';
    settings.style.display = open ? 'none' : '';
    settingsBtn.textContent = open ? 'è¨­å®š' : 'é–‰ã˜ã‚‹';
    if(open){
      applyBtn.style.display='none';
      footer.style.display='';
    }else{
      footer.style.display='none';
    }
  });
})();
</script>
</body>
</html>
