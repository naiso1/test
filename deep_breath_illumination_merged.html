<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>æ·±å‘¼å¸èª˜ç™ºã‚·ã‚¹ãƒ†ãƒ  â€“ Mobile v3</title>
<style>
:root{
  --color-inhale:#76c7c0;
  --color-hold:#f7c59f;
  --color-exhale:#ff6f61;
  --color-rest:#74b9ff;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","YuGothic","Meiryo",sans-serif;
  color:#fff;
  background:#000 url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1400&q=60') center/cover no-repeat fixed;
  display:flex;justify-content:center;align-items:center;min-height:100dvh;
}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55)}
.container{
  position:relative;z-index:1;width:min(95%,1040px);
  background:rgba(0,0,0,.6);border-radius:14px;padding:clamp(1rem,4vw,2rem);text-align:center;
}
h1{font-size:1.6rem;margin-bottom:8px}
.timings{margin:16px 0}
.timings .row{display:flex;gap:8px;margin-bottom:8px}
.timings label{display:flex;align-items:center;gap:4px;flex:1;margin:0}
.paramtable{width:100%;border-collapse:collapse;margin:16px 0;font-size:.9rem}
.paramtable th,.paramtable td{border:1px solid #999;padding:4px;text-align:left}
#customInputs th:nth-child(2),#customInputs td:nth-child(2),
#customInputs th:nth-child(3),#customInputs td:nth-child(3){width:30%}
label{display:block;margin:12px 0 4px;font-size:.9rem}
select,input[type="number"],input[type="color"]{
  width:100%;padding:6px 8px;font-size:1rem;border:none;border-radius:4px;margin-bottom:12px
}
.patterns{width:100%;border-collapse:collapse;margin:16px auto;font-size:.8rem}
.patterns th,.patterns td{border:1px solid #999;padding:4px}
.patterns tbody tr.selected{background:rgba(255,255,255,.3)}
.mode-buttons button,.sound-buttons button{
  margin:4px;padding:10px 16px;font-size:1rem;border:none;border-radius:8px;cursor:pointer
}
.mode-buttons button.active,.sound-buttons button.active{background:#555;color:#fff}
.mode-buttons{margin:16px 0}
#barContainer{
  position:relative;margin:24px auto;width:100%;max-width:1120px;height:40px;
  background:#444;border-radius:20px;overflow:hidden
}
#breathBar{
  position:absolute;left:50%;top:0;height:100%;width:0%;
  background:#fff;border-radius:20px;transform:translateX(-50%);
  transform-origin:center;border-radius:20px;
  transition:width 1s linear,background-color .8s
}
button{
  margin:4px 6px;padding:10px 24px;font-size:1rem;font-weight:600;border:none;border-radius:8px;cursor:pointer
}
#startBtn{background:#76c7c0;color:#000}
#stopBtn{background:#ff6f61;color:#000}
#applyBtn{background:#74b9ff;color:#000}
button:disabled{opacity:.6}
@media(hover:hover) and (pointer:fine){button:hover{filter:brightness(.9)}}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="container">
  <h1>æ·±å‘¼å¸èª˜ç™ºã‚·ã‚¹ãƒ†ãƒ </h1>
  <div id="barContainer"><div id="breathBar"></div></div>
  <div id="phaseText">æº–å‚™ä¸­...</div>
  <div id="timerText">--</div>

  <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button id="stopBtn">ã‚¹ãƒˆãƒƒãƒ—</button>
  <button id="applyBtn">é©ç”¨</button>
  <button id="settingsBtn">è¨­å®š</button>

  <div id="settings" style="display:none">
  <p style="margin-bottom:8px;font-size:.9rem">ä¸‹è¨˜ã®è¡¨ã‚’å‚è€ƒã«ç›®çš„ã«åˆã£ãŸå‘¼å¸æ³•ã‚’é¸æŠã—ã€å›æ•°ã‚„æ™‚é–“ã‚’è¨­å®šã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚</p>

  <input type="hidden" id="patternSelect" value="3.3-0-6.7-0">

  <table id="customInputs" class="paramtable">
    <thead>
      <tr><th></th><th>ç§’æ•°</th><th>è‰²</th></tr>
    </thead>
    <tbody>
      <tr><th>å¸ã†</th><td><input type="number" id="inhaleSec" min="1" value="5"></td><td><input type="color" id="colorInhale" value="#76c7c0"></td></tr>
      <tr><th>æ­¢ã‚ã‚‹</th><td><input type="number" id="holdSec" min="0" value="0"></td><td><input type="color" id="colorHold" value="#f7c59f"></td></tr>
      <tr><th>åã</th><td><input type="number" id="exhaleSec" min="1" value="5"></td><td><input type="color" id="colorExhale" value="#ff6f61"></td></tr>
      <tr><th>æ­¢ã‚ã‚‹</th><td><input type="number" id="restSec" min="0" value="0"></td><td><input type="color" id="colorRest" value="#74b9ff"></td></tr>
    </tbody>
  </table>

  <div class="timings">
    <div class="row">
      <label>å›æ•°(0=ç„¡é™): <input type="number" id="cycleCount" min="0" value="0"></label>
      <label>æ™‚é–“(åˆ†,0=ç„¡é™): <input type="number" id="totalMinutes" min="0" value="0"></label>
    </div>
  </div>

  <table class="patterns">
    <thead>
      <tr><th>å‘¼å¸ãƒªã‚ºãƒ </th><th>åç§°</th><th>ä¸»ãªç›®çš„ãƒ»é©ç”¨ã‚·ãƒ¼ãƒ³</th><th>ä¸»ãªèº«ä½“çš„å¤‰åŒ–</th><th>ä¸»ãªå¿ƒç†çš„å¤‰åŒ–</th><th>æ¨å¥¨å›æ•°/æ™‚é–“</th></tr>
    </thead>
    <tbody>
      <tr data-pattern="4-7-8-0"><td>4-7-8</td><td>4-7-8ãƒ–ãƒªãƒ¼ã‚¸ãƒ³ã‚°</td><td>å…¥çœ å‰ãƒ»æ€¥æ€§ä¸å®‰ã®é®é™</td><td>HRVâ†‘ã€å¿ƒæ‹â†“ã€è¡€åœ§â†“</td><td>å…¥çœ æ™‚é–“çŸ­ç¸®ã€ä¸»è¦³çš„ä¸å®‰â†“</td><td>4ã‚»ãƒƒãƒˆ</td></tr>
      <tr data-pattern="4-4-4-4"><td>4-4-4-4</td><td>ãƒœãƒƒã‚¯ã‚¹</td><td>é«˜ã‚¹ãƒˆãƒ¬ã‚¹ä¸‹ã§ã®é›†ä¸­ç¶­æŒï¼ˆè»ãƒ»è­¦å¯Ÿè¨“ç·´ã»ã‹ï¼‰</td><td>å‰¯äº¤æ„Ÿå„ªä½åŒ–ã€ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«â†“</td><td>é›†ä¸­åŠ›â†‘ã€æƒ…å‹•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</td><td>3åˆ†</td></tr>
      <tr data-pattern="5-0-5-0"><td>5-5</td><td>ãƒ¬ã‚¾ãƒŠãƒ³ã‚¹</td><td>HRVæœ€å¤§åŒ–ã€é•·æœŸã‚¹ãƒˆãƒ¬ã‚¹è€æ€§</td><td>HRVâ†‘ã€è¡€åœ§å¤‰å‹•æ•´æµ</td><td>æ°—åˆ†å®‰å®šã€èªçŸ¥æŸ”è»Ÿæ€§â†‘</td><td>5åˆ†</td></tr>
      <tr data-pattern="3.3-0-6.7-0"><td>3.3-6.7</td><td>ãƒ¯ãƒ³ãƒ„ãƒ¼å‘¼å¸æ³•</td><td>ä»•äº‹ä¸­ãƒ»é‹è»¢å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</td><td>æœ«æ¢¢è¡€æµâ†‘ã€å¿ƒæ‹â†“</td><td>ã‚¹ãƒˆãƒ¬ã‚¹ã‚¹ã‚³ã‚¢â†“ã€æ°—åˆ†å›å¾©</td><td>5åˆ†</td></tr>
      <tr data-pattern="7-0-11-0"><td>7-11</td><td>7-11ãƒ–ãƒªãƒ¼ã‚¸ãƒ³ã‚°</td><td>æ€¥æ€§ã®ç·Šå¼µç·©å’Œã€èˆå°å‰ãƒ»å•†è«‡å‰</td><td>å‘¼å¸æ•°â†“ã€è¿·èµ°ç¥çµŒåˆºæ¿€</td><td>ä¸å®‰â†“ã€è½ã¡ç€ãâ†‘</td><td>3åˆ†</td></tr>
      <tr data-pattern="4-2-4-0"><td>4-2-4</td><td>ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«ãƒ–ãƒªãƒ¼ã‚¸ãƒ³ã‚°</td><td>å³å¿œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¶­æŒï¼ˆå°„æ’ƒãƒ»è©¦é¨“å‰ï¼‰</td><td>SpOâ‚‚å®‰å®šã€å¿ƒæ‹ãƒªã‚»ãƒƒãƒˆ</td><td>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¶­æŒã€ä¸å®‰â†“</td><td>2åˆ†</td></tr>
      <tr data-pattern="custom"><td>-</td><td>ã‚«ã‚¹ã‚¿ãƒ </td><td colspan="4">ä»»æ„è¨­å®š</td></tr>
    </tbody>
  </table>
  <p style="font-size:.8rem;opacity:.6">* æ¨å¥¨å›æ•°/æ™‚é–“ã¯ä¸€èˆ¬çš„ãªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ç›®å®‰ã§ã™ã€‚ä½“èª¿ã‚„ç›®çš„ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</p>

  <div class="mode-buttons">
    <button type="button" class="modeBtn active" data-mode="expand">ğŸ”† æ‹¡ç¸®</button>
    <button type="button" class="modeBtn" data-mode="color">ğŸ¨ è‰²å¤‰åŒ–</button>
  </div>
  <div class="sound-buttons">
    <button type="button" class="soundBtn active" data-sound="off">âŒ ãªã—</button>
    <button type="button" class="soundBtn" data-sound="wave">ğŸŒŠ æ³¢ã®éŸ³</button>
    <button type="button" class="soundBtn" data-sound="birds">ğŸ¦ é³¥ã®ã•ãˆãšã‚Š</button>
    <button type="button" class="soundBtn" data-sound="onsen">â™¨ï¸ æ¸©æ³‰ã®éŸ³</button>
    <button type="button" class="soundBtn" data-sound="bubble">ğŸ«§ æ³¡é¢¨å‘‚</button>
    <button type="button" class="soundBtn" data-sound="wind">ğŸŒ¬ï¸ é¢¨ã®éŸ³</button>
    <button type="button" class="soundBtn" data-sound="shishi">ğŸ ã—ã—ãŠã©ã—</button>
    <button type="button" class="soundBtn" data-sound="rain">ğŸŒ§ï¸ é›¨ã®éŸ³</button>
  </div>
  <input type="hidden" id="sound" value="off">
  </div>

  <footer style="margin-top:16px;font-size:.7rem;opacity:.5">v3 â€“ Generated 2025-06-06 07:59:20</footer>
</div>

<script>
(function(){
  const patternSelect = document.getElementById('patternSelect');
  const customInputs  = document.getElementById('customInputs');
  const startBtn      = document.getElementById('startBtn');
  const stopBtn       = document.getElementById('stopBtn');
  const breathBar     = document.getElementById('breathBar');
  const phaseText     = document.getElementById('phaseText');
  const timerText     = document.getElementById('timerText');
  const soundSel      = document.getElementById('sound');
  const cycleInput    = document.getElementById('cycleCount');
  const minuteInput   = document.getElementById('totalMinutes');
  const applyBtn      = document.getElementById('applyBtn');
  const settings      = document.getElementById('settings');
  const settingsBtn   = document.getElementById('settingsBtn');
  const patternRows   = document.querySelectorAll('.patterns tbody tr');
  const modeBtns      = document.querySelectorAll('.modeBtn');
  const soundBtns     = document.querySelectorAll('.soundBtn');

  const defaultBg = 'https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1400&q=60';
  const bgMap = {
    off: defaultBg,
    wave: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1400&q=60',
    birds: 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=1400&q=60',
    onsen: 'https://images.unsplash.com/photo-1500169066331-3fe2c6167a8d?auto=format&fit=crop&w=1400&q=60',
    bubble: 'https://images.unsplash.com/photo-1516376128745-7dcb70d19147?auto=format&fit=crop&w=1400&q=60',
    wind: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1400&q=60',
    shishi: 'https://images.unsplash.com/photo-1594628460799-9d548f950292?auto=format&fit=crop&w=1400&q=60',
    rain: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1400&q=60'
  };

  function updateBackground(){
    const url = bgMap[soundSel.value] || defaultBg;
    document.body.style.background = `#000 url('${url}') center/cover no-repeat fixed`;
  }

  const recommendedMap = {
    '4-7-8-0': '4ã‚»ãƒƒãƒˆ',
    '4-4-4-4': '3åˆ†',
    '5-0-5-0': '5åˆ†',
    '3.3-0-6.7-0': '5åˆ†',
    '7-0-11-0': '3åˆ†',
    '4-2-4-0': '2åˆ†'
  };

  let timerId = null;
  let currentPhase = 0;
  let mode = 'expand';
  let running = false;
  let audioCtx = null;
  let cycleLimit = 0;
  let timeLimit  = 0;
  let cyclesDone = 0;
  let startTime  = 0;
  let cycleStarted = false;
  const buffers = {};

  const phaseNames = ['å¸ã£ã¦ã€œ','æ­¢ã‚ã¦ã€œ','åã„ã¦ã€œ','æ­¢ã‚ã¦ã€œ'];

  const inhaleInput = document.getElementById('inhaleSec');
  const holdInput   = document.getElementById('holdSec');
  const exhaleInput = document.getElementById('exhaleSec');
  const restInput   = document.getElementById('restSec');

  function updateInputsFromPattern(){
    const arr = patternSelect.value.split('-').map(n=>parseFloat(n));
    while(arr.length < 4) arr.push(0);
    [inhaleInput,holdInput,exhaleInput,restInput].forEach((el,i)=>{
      if(patternSelect.value !== 'custom') el.value = arr[i];
      el.disabled = patternSelect.value !== 'custom';
    });
    const rec = recommendedMap[patternSelect.value];
    if(rec){
      if(rec.includes('ã‚»ãƒƒãƒˆ')){
        const m = rec.match(/(\d+)/g);
        cycleInput.value = m ? parseInt(m[m.length-1]) : 0;
        minuteInput.value = 0;
      } else if(rec.includes('åˆ†')){
        const m = rec.match(/(\d+)(?:-(\d+))?/);
        minuteInput.value = m ? parseInt(m[2] || m[1]) : 0;
        cycleInput.value = 0;
      }
    }
  }

  patternRows.forEach(row => {
    if(row.dataset.pattern===patternSelect.value) row.classList.add('selected');
    row.addEventListener('click', () => {
      patternRows.forEach(r=>r.classList.remove('selected'));
      row.classList.add('selected');
      patternSelect.value = row.dataset.pattern;
      updateInputsFromPattern();
    });
  });
  updateInputsFromPattern();
  soundBtns.forEach(btn => {
    if(btn.dataset.sound===soundSel.value) btn.classList.add('active');
    btn.addEventListener('click', () => {
      soundBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      soundSel.value = btn.dataset.sound;
      updateBackground();
    });
  });
  updateBackground();
  modeBtns.forEach(btn => {
    if(btn.dataset.mode===mode) btn.classList.add('active');
    btn.addEventListener('click', () => {
      modeBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      mode = btn.dataset.mode;
    });
  });

  const audioEls = {wave:new Audio('æ³¢ã®éŸ³.mp3'), birds:new Audio('é³¥ã®ã•ãˆãšã‚Š.mp3')};
  audioEls.wave.loop = audioEls.birds.loop = true;
  const soundFiles = {wave:'', birds:''};
  async function initAudio(){
    if(soundSel.value==='wave' || soundSel.value==='birds') return;
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const file = soundFiles[soundSel.value];
    if(file && !buffers[soundSel.value]){
      const res = await fetch(file);
      const arr = await res.arrayBuffer();
      buffers[soundSel.value] = await audioCtx.decodeAudioData(arr);
    }
  }
  function createNoiseBuffer(){
    const buffer = audioCtx.createBuffer(1,audioCtx.sampleRate,audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = Math.random()*2-1;
    return buffer;
  }
  function onsenBuffer(){
    if(buffers.onsen) return buffers.onsen;
    const buffer = createNoiseBuffer();
    buffers.onsen = buffer; return buffer;
  }
  function bubbleBuffer(){
    if(buffers.bubble) return buffers.bubble;
    const len = audioCtx.sampleRate*3;
    const b = audioCtx.createBuffer(1,len,audioCtx.sampleRate);
    const d = b.getChannelData(0);
    for(let i=0;i<len;i++) d[i]=0;
    for(let k=0;k<20;k++){
      const start=Math.floor(Math.random()*(len-500));
      for(let j=0;j<500;j++){
        const t=j/500;
        d[start+j]+=Math.sin(2*Math.PI*400*(1+t)*t)*Math.exp(-6*t);
      }
    }
    buffers.bubble=b;return b;
  }
  function shishiBuffer(){
    if(buffers.shishi) return buffers.shishi;
    const len = audioCtx.sampleRate*3;
    const b = audioCtx.createBuffer(1,len,audioCtx.sampleRate);
    const d = b.getChannelData(0);
    for(let i=0;i<len;i++) d[i] = 0;
    for(let j=0;j<0.25*audioCtx.sampleRate;j++){const t=j/audioCtx.sampleRate;d[j]+=Math.sin(2*Math.PI*400*t)*Math.exp(-15*t);} 
    buffers.shishi = b; return b;
  }
  function playPhase(dur, from, to){
    if(soundSel.value==='off') return;
    if(soundSel.value==='wave' || soundSel.value==='birds'){
      const el = audioEls[soundSel.value];
      el.volume = from;
      if(el.paused) el.play();
      const diff = to-from;
      const steps = Math.max(1,Math.floor(dur*10));
      let c=0;
      clearInterval(el._fade);
      el._fade=setInterval(()=>{
        c++; el.volume = from + diff*c/steps;
        if(c>=steps){
          clearInterval(el._fade);
          if(to===0){ el.pause(); el.currentTime=0; }
        }
      },100);
      return;
    }
    const src = audioCtx.createBufferSource();
    const gain = audioCtx.createGain();
    let filter;
    if(soundSel.value==='onsen'){src.buffer=onsenBuffer();src.loop=true;filter=audioCtx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=600;}
    else if(soundSel.value==='bubble'){src.buffer=bubbleBuffer();src.loop=true;filter=audioCtx.createBiquadFilter();filter.type='bandpass';filter.frequency.value=800;}
    else if(soundSel.value==='wind'){src.buffer=createNoiseBuffer();src.loop=true;filter=audioCtx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=800;}
    else if(soundSel.value==='rain'){src.buffer=createNoiseBuffer();src.loop=true;filter=audioCtx.createBiquadFilter();filter.type='highpass';filter.frequency.value=1000;}
    else if(soundSel.value==='shishi'){src.buffer=shishiBuffer();src.loop=true;}
    if(filter) src.connect(filter).connect(gain); else src.connect(gain);
    gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(from,audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(to,audioCtx.currentTime+dur);
    src.start();
    src.stop(audioCtx.currentTime+dur+0.1);
  }

  function getDurations(){
    if(patternSelect.value === 'custom'){
      const inhale = parseFloat(inhaleInput.value) || 0;
      const hold   = parseFloat(holdInput.value) || 0;
      const exhale = parseFloat(exhaleInput.value) || 0;
      const rest   = parseFloat(restInput.value) || 0;
      return [inhale,hold,exhale,rest];
    }
    const arr = patternSelect.value.split('-').map(n=>parseFloat(n));
    while(arr.length < 4) arr.push(0);
    return arr;
  }
  const colorInhale = document.getElementById('colorInhale');
  const colorHold   = document.getElementById('colorHold');
  const colorExhale = document.getElementById('colorExhale');
  const colorRest   = document.getElementById('colorRest');

  function getColors(){
    return [
      colorInhale.value,
      colorHold.value,
      colorExhale.value,
      colorRest.value
    ];
  }
  function setBar(widthPercent,duration,color){
    breathBar.style.transition = `width ${duration}s linear, background-color .8s`;
    breathBar.style.width = widthPercent + '%';
    breathBar.style.backgroundColor = color;
  }

  async function stopSession(){
    if(timerId) clearInterval(timerId);
    timerId = null;
    running = false;
    breathBar.style.transition = 'none';
    breathBar.style.width = '0%';
    void breathBar.offsetWidth;
    breathBar.style.transition = '';
    phaseText.textContent = 'æº–å‚™ä¸­...';
    timerText.textContent = '--';
    startBtn.disabled = false;
    if(audioCtx){
      await audioCtx.close();
      audioCtx = null;
      for(const k in buffers) buffers[k] = null;
    }
    Object.values(audioEls).forEach(el=>{if(el._fade) clearInterval(el._fade); el.pause(); el.currentTime=0;});
  }

  function nextPhase(){
    const durations = getDurations();
    const colors    = getColors();

    let guard = 0;
    while(durations[currentPhase] === 0 && guard < 4){
      currentPhase = (currentPhase + 1) % 4;
      guard++;
    }

    if(currentPhase === 0){
      if(cycleStarted){
        cyclesDone++;
        if(cycleLimit > 0 && cyclesDone >= cycleLimit){
          stopSession();
          return;
        }
      }
      cycleStarted = true;
    }
    if(timeLimit > 0 && Date.now() - startTime >= timeLimit){
      stopSession();
      return;
    }

    const duration = durations[currentPhase];
    const color    = colors[currentPhase];

    phaseText.textContent = phaseNames[currentPhase] || '';
    if(mode === 'expand'){
      setBar(currentPhase < 2 ? 100 : 0, duration, color);
    } else {
      setBar(100, 0.8, color);
    }

    if(currentPhase === 0){
      playPhase(duration,0,1);
    } else if(currentPhase === 1){
      playPhase(duration,1,1);
    } else if(currentPhase === 2){
      playPhase(duration,1,0);
    } else if(currentPhase === 3){
      playPhase(duration,0,0);
    }

    if(duration === 0){
      currentPhase = (currentPhase + 1) % 4;
      nextPhase();
      return;
    }

    let start = Date.now();
    let end   = start + duration*1000;
    timerText.textContent = duration.toFixed(1) + ' ç§’';

    timerId = setInterval(()=>{
      const now = Date.now();
      const remaining = Math.max(0,(end - now)/1000);
      timerText.textContent = remaining.toFixed(1) + ' ç§’';

      if(timeLimit > 0 && now - startTime >= timeLimit){
        stopSession();
        return;
      }

      if(remaining <= 0){
        clearInterval(timerId);
        currentPhase = (currentPhase + 1) % 4;
        nextPhase();
      }
    }, 100);
  }

  async function startSession(){
    if(soundSel.value !== 'off') await initAudio();
    running = true;
    currentPhase = 0;
    cyclesDone = 0;
    cycleStarted = false;
    cycleLimit = parseInt(cycleInput.value,10) || 0;
    timeLimit  = (parseFloat(minuteInput.value) || 0) * 60000;
    startTime  = Date.now();
    nextPhase();
    startBtn.disabled = true;
  }

  startBtn.addEventListener('click', async ()=>{
    if(running) return;
    await startSession();
  });

  applyBtn.addEventListener('click', async ()=>{
    await stopSession();
    await startSession();
  });

  stopBtn.addEventListener('click', async ()=>{
    await stopSession();
  });

  settingsBtn.addEventListener('click', ()=>{
    const open = settings.style.display !== 'none';
    settings.style.display = open ? 'none' : '';
    settingsBtn.textContent = open ? 'è¨­å®š' : 'é–‰ã˜ã‚‹';
  });
})();
</script>
</body>
</html>
