<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>深呼吸誘発イルミ – Mobile v3</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","YuGothic","Meiryo",sans-serif;
  color:#fff;
  background:#000 url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1400&q=60') center/cover no-repeat fixed;
  display:flex;justify-content:center;align-items:center;min-height:100dvh;
}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55)}
.container{
  position:relative;z-index:1;width:min(95%,520px);
  background:rgba(0,0,0,.6);border-radius:14px;padding:clamp(1rem,4vw,2rem);text-align:center;
}
h1{font-size:1.6rem;margin-bottom:8px}
label{display:block;margin:12px 0 4px;font-size:.9rem}
select,input[type="number"],input[type="color"]{
  width:100%;padding:6px 8px;font-size:1rem;border:none;border-radius:4px;margin-bottom:12px
}
.colors,.mode-select{margin:16px 0}
.mode-select label{display:inline-flex;align-items:center;gap:4px;margin:0 8px}
#barContainer{
  position:relative;margin:24px auto;width:100%;max-width:560px;height:40px;
  background:#444;border-radius:20px;overflow:hidden
}
#breathBar{
  position:absolute;left:50%;top:0;height:100%;width:0%;
  background:#fff;border-radius:20px;transform:translateX(-50%);
  transform-origin:center;border-radius:20px;
  transition:width 1s linear,background-color .8s
}
button{
  margin:4px 6px;padding:10px 24px;font-size:1rem;font-weight:600;border:none;border-radius:8px;cursor:pointer
}
#startBtn{background:#76c7c0;color:#000}
#stopBtn{background:#ff6f61;color:#000}
button:disabled{opacity:.6}
@media(hover:hover) and (pointer:fine){button:hover{filter:brightness(.9)}}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="container">
  <h1>深呼吸誘発イルミ</h1>

  <label for="patternSelect">呼吸パターン:</label>
  <select id="patternSelect">
    <option value="5-0-5" selected>5-0-5 呼吸法</option>
    <option value="4-7-8">4-7-8 呼吸法</option>
    <option value="5-5-5">5-5-5 呼吸法</option>
    <option value="4-0-4">4-0-4 呼吸法</option>
    <option value="6-0-6">6-0-6 呼吸法</option>
    <option value="3-3-6">3-3-6 呼吸法</option>
    <option value="custom">カスタム</option>
  </select>

  <div id="customInputs" style="display:none;">
    <label>吸う秒数: <input type="number" id="inhaleSec" min="1" value="5"></label>
    <label>止める秒数: <input type="number" id="holdSec" min="0" value="0"></label>
    <label>吐く秒数: <input type="number" id="exhaleSec" min="1" value="5"></label>
  </div>

  <div class="colors">
    <label>吸う色: <input type="color" id="colorInhale" value="#76c7c0"></label>
    <label>止める色: <input type="color" id="colorHold" value="#f7c59f"></label>
    <label>吐く色: <input type="color" id="colorExhale" value="#ff6f61"></label>
  </div>

  <div class="mode-select">
    <label><input type="radio" name="mode" value="expand" checked> 光の広がり</label>
    <label><input type="radio" name="mode" value="color"> 色変化のみ</label>
  </div>

  <div id="barContainer"><div id="breathBar"></div></div>
  <div id="phaseText">準備中...</div>
  <div id="timerText">--</div>

  <button id="startBtn">スタート</button>
  <button id="stopBtn">ストップ</button>

  <footer style="margin-top:16px;font-size:.7rem;opacity:.5">v3 – Generated 2025-06-06 07:59:20</footer>
</div>

<script>
(function(){
  const patternSelect = document.getElementById('patternSelect');
  const customInputs  = document.getElementById('customInputs');
  const startBtn      = document.getElementById('startBtn');
  const stopBtn       = document.getElementById('stopBtn');
  const breathBar     = document.getElementById('breathBar');
  const phaseText     = document.getElementById('phaseText');
  const timerText     = document.getElementById('timerText');

  let timerId = null;
  let currentPhase = 0;
  let mode = 'expand';
  let running = false;

  const phaseNames = ['吸って〜','止めて〜','吐いて〜'];

  // UI Event bindings
  patternSelect.addEventListener('change', ()=> {
    customInputs.style.display = (patternSelect.value === 'custom')? 'block':'none';
  });
  document.querySelectorAll('input[name="mode"]').forEach(radio => {
    radio.addEventListener('change', e => mode = e.target.value);
  });

  // Utility
  function getDurations(){
    if(patternSelect.value === 'custom'){
      const inhale = parseInt(document.getElementById('inhaleSec').value,10)||0;
      const hold   = parseInt(document.getElementById('holdSec').value,10)||0;
      const exhale = parseInt(document.getElementById('exhaleSec').value,10)||0;
      return [inhale,hold,exhale];
    }
    return patternSelect.value.split('-').map(n=>parseInt(n,10));
  }
  function getColors(){
    return [
      document.getElementById('colorInhale').value,
      document.getElementById('colorHold').value,
      document.getElementById('colorExhale').value
    ];
  }
  function setBar(widthPercent,duration,color){
    breathBar.style.transition = `width ${duration}s linear, background-color .8s`;
    breathBar.style.width = widthPercent + '%';
    breathBar.style.backgroundColor = color;
  }

  // Main cycle
  function nextPhase(){
    const durations = getDurations();
    const colors    = getColors();

    // Skip 0‑second phases robustly
    let guard = 0;
    while(durations[currentPhase] === 0 && guard < 3){
      currentPhase = (currentPhase + 1) % 3;
      guard++;
    }

    const duration = durations[currentPhase];
    const color    = colors[currentPhase];

    phaseText.textContent = phaseNames[currentPhase] || '';
    if(mode === 'expand'){
      setBar(currentPhase < 2 ? 100 : 0, duration, color);
    } else {
      setBar(100, 0.8, color);
    }

    if(duration === 0){
      // immediate skip
      currentPhase = (currentPhase + 1) % 3;
      nextPhase();
      return;
    }

    let remaining = duration;
    timerText.textContent = remaining + ' 秒';

    timerId = setInterval(()=>{
      remaining--;
      timerText.textContent = remaining + ' 秒';
      if(remaining <= 0){
        clearInterval(timerId);
        currentPhase = (currentPhase + 1) % 3;
        nextPhase();
      }
    }, 1000);
  }

  // Controls
  startBtn.addEventListener('click', ()=>{
    if(running) return;
    running = true;
    currentPhase = 0;
    nextPhase();
    startBtn.disabled = true;
  });

  stopBtn.addEventListener('click', ()=>{
    if(timerId) clearInterval(timerId);
    running = false;
    breathBar.style.width = '0%';
    phaseText.textContent = '準備中...';
    timerText.textContent = '--';
    startBtn.disabled = false;
  });

})(); // IIFE
</script>
</body>
</html>
